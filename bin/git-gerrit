#!/bin/bash

this=$(basename "$0")

# colors
RED="\033[0;31m"
YELLOW="\033[1;33m"
GREEN="\033[0;32m"
NO_COLOR="\033[0m"
BOLD="\033[1m"
UNDERLINE="\033[4m"

die() {
	echo -e "${RED}${@}${NO_COLOR}"
	exit 1
}

warn() {
	echo -e "${YELLOW}${@}${NO_COLOR}"
}

good() {
	echo -e "${GREEN}${@}${NO_COLOR}"
}

# Check commands
GIT=$(which git)
if [[ -z "$GIT" ]]; then
	die "git is not installed"
fi

SSH=$(which ssh)
if [[ -z "$SSH" ]]; then
	die "ssh is not installed"
fi

GIT_DIR=$($GIT rev-parse --git-dir 2>/dev/null)

if [[ -z "$GIT_DIR" ]]; then
	die "$this can only be run from a git repository."
fi

url_line=$($GIT remote show -n origin | grep "Push  URL: " | head -n1)
host_and_project=${url_line# *URL: }

host=''
project=''
port=''

if [[ "$host_and_project" =~ "ssh://" ]]; then
	host_and_project=${host_and_project#ssh://}
	host_and_port=${host_and_project%/*}

	if [[ "$host_and_port" =~ ":" ]]; then
		host=${host_and_port%:*}
		port=${host_and_port#*:}
	else
		host=${host_and_port}
		port=""
	fi
	project=${host_and_project#*/}
else
	host=${host_and_project%:*}
	project=${host_and_project#*:}
	port=""
fi

port=${port%/*}
if [[ ! -z "$port" ]]; then
	port="-p $port"
fi

ssh $host $port gerrit $@
